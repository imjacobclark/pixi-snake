<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Snake</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/5.1.3/pixi.min.js"></script>
    <script src="https://pixijs.io/pixi-sound/dist/pixi-sound.js"></script>
  
    <style>
      body {
          margin: 0;
          padding: 0;
          text-align: center;
          overflow: hidden;
      }
    </style>

    <meta name="viewport" content="width=device-width, user-scalable=no" />
    <link rel="manifest" href="manifest.json" />
  </head>

  <body>
    <script type="module">
      navigator.serviceWorker && navigator.serviceWorker.register('./sw.js').then(registration => {
          console.log('Excellent, registered with scope: ', registration.scope);
      });

      const ONE_BLOCK_IN_PIXELS = 10;
      const SCREEN_OUT_OF_BOUNDS_OFFSET = 1;
      const DIED_SOUND = PIXI.sound.Sound.from('./resources/sounds/died.mp3');
      const EAT_SOUND = PIXI.sound.Sound.from('./resources/sounds/eat.mp3');

      import Snake from './src/Snake/Snake.js';
      import Food from './src/Food/Food.js';
      import Controls from './src/Game/Controls.js';
      import Text from './src/Game/Text.js';
      import Collision from './src/Collision/Collision.js';
      import { Status, RUNNING } from './src/Game/Status.js';

      const collision = new Collision(window.innerWidth, window.innerHeight);
      const snake = new Snake(new PIXI.Graphics(), collision);
      const food = new Food(20, 20, new PIXI.Graphics());
      const status = new Status(new PIXI.Graphics(), new Text("", window.innerHeight - 30, 20));
      const controls = new Controls(snake, status).create();

      const snakeApplication = new PIXI.Application({
        width: window.innerWidth,
        height: window.innerHeight,
        antialias: true,
        transparent: false,
        resolution: 1
      });

      let type = "WebGL"

      if (!PIXI.utils.isWebGLSupported()) {
        type = "canvas"
      }

      PIXI.ticker.maxFPS = 1;
      snakeApplication.ticker.maxFPS = 1;

      document.body.appendChild(snakeApplication.view);
      
      snakeApplication.ticker.add(delta => {
        if(snake.hasCollidedWithSelf() || snake.hasGoneOutOfBounds()) {
          if(status.status === RUNNING){
            DIED_SOUND.play();
            snake.flash();
          }

          status.setLost();
          
          return
        }

        if (collision.hasCollided(snake.cells[0], food)) {
          EAT_SOUND.play();
          snake.grow();
          
          food.randomlyReposition(
            window.innerWidth / (ONE_BLOCK_IN_PIXELS + SCREEN_OUT_OF_BOUNDS_OFFSET), 
            window.innerHeight / (ONE_BLOCK_IN_PIXELS + SCREEN_OUT_OF_BOUNDS_OFFSET)
          );
        }

        if (status.status === RUNNING) {
          snake.move();
        }

        snake.draw();
        food.draw();
        status.draw();
      });
      
      snakeApplication.stage.addChild(snake.graphics);
      snakeApplication.stage.addChild(food.graphics);
      snakeApplication.stage.addChild(status.graphics);
    </script>
  </body>
</html>